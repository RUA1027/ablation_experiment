# 基于NewBP算法的自适应光学与图像复原联合优化机制研究报告

## 1. 绪论：计算成像中的物理与算法融合

### 1.1 研究背景与意义

在现代光学成像领域，硬件的物理极限与成像质量的需求之间存在着日益显著的矛盾。传统的自适应光学（Adaptive Optics, AO）系统依赖于波前传感器（如Shack-Hartmann传感器）和变形镜硬件来实时校正大气湍流或系统像差。然而，在消费级摄影、显微成像及遥感探测等应用中，部署昂贵且复杂的AO硬件往往是不切实际的。这催生了“计算自适应光学”或“无波前传感器自适应光学”的需求，即通过算法直接从模糊的观测图像中反演波前像差并进行数字校正。

本报告所探讨的系统架构，代表了该领域的一种前沿范式：**物理引导的深度学习（Physics-Informed Deep Learning）**。不同于传统的端到端“黑盒”神经网络，该系统内嵌了一个可微分的物理光学仿真层。通过将光学成像过程（从Zernike系数到PSF的生成）数学化为网络的一部分，我们利用NewBP算法在“图像复原”和“像差估计”两个任务之间建立了直接的梯度联系 1。

### 1.2 问题定义：盲解卷积与系统辨识的耦合

我们面临的是一个高度病态（Ill-posed）的逆问题。给定观测到的模糊图像 $Y_{real}$，我们需要同时求解：

1. **潜在的清晰图像 $X$**：这是图像复原的任务。
2. **光学系统的模糊核 $K$**：这是系统辨识的任务，且该核由一组Zernike系数 $C$ 参数化。

成像模型可表示为卷积过程：
$$
Y_{real} = X * K(C) + N
$$
其中 $N$ 为噪声。NewBP算法的核心挑战在于如何解耦 $X$ 和 $K$。若没有物理约束，网络极易陷入平凡解（例如 $K$ 为狄拉克函数，$X$ 直接等于 $Y_{real}$）。

本系统通过引入Zernike多项式基底约束 $K$ 的形态，并利用双支路架构（图像支路与光学支路）进行协同优化，从根本上解决了这一模糊性。

### 1.3 本报告的结构与目标

本报告将超越表层的概念描述，深入到底层的微积分与线性代数层面，提供一份长篇幅、高密度的技术推演。

- **定义**：精确定义广义光瞳函数、波前像差函数及其与Zernike系数的映射关系。
- **推导**：利用复变函数微积分和傅里叶变换性质，推导PSF对Zernike系数的解析梯度。
- **解析**：剖析NewBP算法如何处理空间变变（Spatially Variant）像差引入的“串扰”（Crosstalk）问题，特别是结合Overlap-Add (OLA) 策略时的梯度分配机制。
- **综合**：展示NewBP如何作为连接“数字世界”（像素权重）与“物理世界”（光程差）的桥梁。

------

## 2. 物理光学建模基础：从Zernike系数到点扩散函数

NewBP算法的有效性建立在精准的物理前向模型之上。只有前向传播（Forward Pass）符合物理定律，反向传播（Backward Pass）的梯度才具有物理意义。

### 2.1 Zernike多项式：波前像差的正交基分解

在光学系统中，波前像差 $W(\rho, \theta)$（或相位 $\Phi$）描述了实际波前与理想球面波之间的光程差。为了将这一连续函数参数化以便于神经网络学习，我们采用Zernike多项式作为基底。

Zernike多项式是一组定义在单位圆（Unit Disk, $\rho \le 1$）上的正交多项式序列。这种正交性对于NewBP至关重要，因为它意味着各个像差模式（如像散、彗差）在参数空间上是解耦的，梯度下降可以独立地优化每一个系数，而不会引起剧烈的参数振荡 1。

#### 2.1.1 数学定义

波前相位 $\Phi$ 分解为：
$$
\Phi(\rho, \theta; C) = \sum_{j=1}^{M} C_j \cdot Z_j(\rho, \theta)
$$
其中：

- $C_j$ 是第 $j$ 个Zernike系数，也是光学支路神经网络的输出目标。
- $(\rho, \theta)$ 是归一化的光瞳极坐标。
- $Z_j$ 是Zernike多项式，通常由径向部分 $R_n^m(\rho)$ 和角向部分 $\Theta_m(\theta)$ 组成。

#### 2.1.2 关键模态与物理意义对照表

为了后续梯度分析的直观性，我们列出前15项Zernike模式及其物理对应关系。理解这些模式对于理解NewBP如何通过图像特征（如边缘拖尾方向）来调整特定系数至关重要。

| **Noll Index (j)** | **名称 (Name)**  | **径向阶数 (n)** | **角向频率 (m)** | **极坐标公式 Zj(ρ,θ)**                | **物理成像特征 (PSF Impact)** | **NewBP梯度敏感特征**        |
| ------------------ | ---------------- | ---------------- | ---------------- | ------------------------------------- | ----------------------------- | ---------------------------- |
| 1                  | Piston (平移)    | 0                | 0                | $1$                                   | 整体相位移动，不改变强度PSF   | 理论梯度应为0 (相位无关性)   |
| 2                  | Tilt X (X倾斜)   | 1                | 1                | $2\rho \cos\theta$                    | 图像整体在X方向平移           | 图像边缘位置偏差             |
| 3                  | Tilt Y (Y倾斜)   | 1                | -1               | $2\rho \sin\theta$                    | 图像整体在Y方向平移           | 图像边缘位置偏差             |
| 4                  | Defocus (离焦)   | 2                | 0                | $\sqrt{3}(2\rho^2 - 1)$               | 光斑均匀扩散为圆盘            | 高频信息丢失，各向同性模糊   |
| 5                  | Astigmatism 1    | 2                | -2               | $\sqrt{6}\rho^2 \sin(2\theta)$        | 光斑拉伸为45度椭圆            | 对角线方向边缘模糊           |
| 6                  | Astigmatism 2    | 2                | 2                | $\sqrt{6}\rho^2 \cos(2\theta)$        | 光斑拉伸为水平/垂直椭圆       | 曼哈顿方向边缘模糊           |
| 7                  | Coma Y (Y彗差)   | 3                | -1               | $\sqrt{8}(3\rho^3 - 2\rho)\sin\theta$ | 彗星状拖尾 (Y轴不对称)        | 上下不对称的光晕             |
| 8                  | Coma X (X彗差)   | 3                | 1                | $\sqrt{8}(3\rho^3 - 2\rho)\cos\theta$ | 彗星状拖尾 (X轴不对称)        | 左右不对称的光晕             |
| 11                 | Spherical (球差) | 4                | 0                | $\sqrt{5}(6\rho^4 - 6\rho^2 + 1)$     | 中心亮斑周围出现光晕          | 图像对比度降低，产生"柔焦"感 |

注：表中使用Noll索引标准，这是自适应光学中最常用的排序方式 1。

### 2.2 广义光瞳函数 (Generalized Pupil Function)

Zernike系数确定了相位，但成像还涉及到孔径限制。我们将这两者结合为广义光瞳函数 $P(\rho, \theta)$​。这是连接几何光学参数与波动光学场的关键步骤。
$$
P(\rho, \theta) = A(\rho, \theta) \cdot \exp\left( i \cdot \frac{2\pi}{\lambda} \cdot \Phi(\rho, \theta; C) \right)
$$

$$
P(\rho, \theta) = A(\rho, \theta) \cdot \exp\left( i \cdot k \sum_{j} C_j Z_j(\rho, \theta) \right)
$$

其中：

- $A(\rho, \theta)$ 是孔径函数（Amplitude），通常对于圆形镜头，在 $\rho \le 1$ 时为1，否则为0。
- $k = 2\pi/\lambda$ 是波数。在归一化计算中，有时将 $k$ 吸收进系数 $C_j$ 中，但这会影响梯度的量纲，我们在推导中保留它以展示物理量级。

### 2.3 点扩散函数 (PSF) 的生成：傅里叶光学的可微性

根据夫琅禾费衍射理论（Fraunhofer Diffraction），在非相干照明条件下（如自然光摄影），成像系统的点扩散函数（PSF）是光瞳函数的傅里叶变换的模平方。

步骤1：相干传递函数 (Amplitude PSF)
$$
h(u, v) = \mathcal{F}\{ P(\rho, \theta) \}
$$

$$
h(u, v) = \iint_{-\infty}^{\infty} P(x, y) e^{-i 2\pi (ux + vy)} dx dy
$$

这里 $(x, y)$ 是光瞳平面的笛卡尔坐标，$(u, v)$ 是像平面的空间频率坐标（对应物理空间坐标）。

步骤2：非相干点扩散函数 (Incoherent PSF)
$$
K(C) = |h(u, v)|^2 = h(u, v) \cdot h^*(u, v)
$$
关键洞察：这一过程：
$$
C \xrightarrow{\text{Zernike}} \Phi \xrightarrow{\exp} P \xrightarrow{\mathcal{F}} h \xrightarrow{|\cdot|^2} K
$$
中的每一步都是可微的。

- 线性组合是可微的。
- 复数指数是可微的（欧拉公式）。
- 傅里叶变换（FFT）是线性变换，当然可微。
- 模平方是二次函数，可微。

这就是NewBP能够“穿透”物理模型进行反向传播的数学基础。不同于传统的优化算法（如遗传算法或单纯形法）需要对PSF进行采样评估，NewBP可以直接计算解析梯度 $\frac{\partial K}{\partial C}$。

------

## 3. 双支路协同网络架构解析

在深入梯度推导之前，我们必须明确梯度的来源和去向。

系统由两个并行的神经网络支路组成，它们在“物理仿真层”汇合。

### 3.1 支路A：图像复原支路 (Image Restoration Net)

- **输入**：真实的模糊观测图像 $Y_{real}$。
- **模型结构**：通常采用U-Net、ResNet或更先进的Transformer架构。
- **参数**：记为 $W$。
- **输出**：估计的潜在清晰图像 $\hat{X} = f_W(Y_{real})$。
- **任务**：学习自然图像的统计先验（如边缘锐度、纹理平滑性），并尝试去除由PSF引入的卷积效应。如果没有物理约束，该网络倾向于输出 $Y_{real}$ 本身（假设 $K$ 为狄拉克函数）。

### 3.2 支路B：物理光学支路 (Physical Optics Net / AberrationNet)

- **输入**：图像的空间坐标网格 $(u, v)$ 或图像的局部特征块。
- **模型结构**：隐式坐标网络（Implicit Neural Representation, INR）或多层感知机（MLP）。
- **参数**：记为 $\theta_{opt}$（注意区分：$C$ 是该网络的输出，$\theta_{opt}$ 是产生 $C$ 的网络权重）。
- **输出**：空间变变的Zernike系数 $C(u, v) = g_{\theta_{opt}}(u, v)$。
- **任务**：建立图像空间位置与光学像差分布之间的映射关系。例如，它需要学习到“视场边缘通常存在较大的像散和彗差”这一物理规律。

### 3.3 汇合点：前向物理仿真 (Forward Simulation)

两个支路的输出在物理层结合，生成“重模糊估计图” $\hat{Y}$：
$$
\hat{Y} = \hat{X} * K(C)
$$
在空间变变（Spatially Variant）模型中，这通过**重叠相加法（Overlap-Add, OLA）**实现：
$$
\hat{Y} = \sum_{i} \text{Crop}(\hat{X}_i) * K(C_i)
$$
其中 $i$ 索引图像的分块（Patch）。

### 3.4 损失函数 (The Loss Landscape)

NewBP的目标是最小化复合损失函数 $\mathcal{L}$ 1：
$$
\mathcal{L} = \mathcal{L}_{fid} + \lambda \mathcal{L}_{reg}
$$

$$
\mathcal{L} = \underbrace{||\hat{Y} - Y_{real}||^2}_{\text{数据保真项 (Fidelity)}} + \lambda \underbrace{||\hat{X} - X_{gt}||^2}_{\text{正则化/监督项 (Prior)}}
$$

- **$\mathcal{L}_{fid}$**：强制物理一致性。即“网络恢复的图像经过网络预测的光学模型模糊后，必须等于观测图像”。
- **$\mathcal{L}_{reg}$**：在训练阶段引入（如有Ground Truth），强制 $\hat{X}$ 逼近真实清晰图像。在无监督测试阶段，此项可替换为全变分（Total Variation）或感知损失（Perceptual Loss）。

------

## 4. NewBP算法原理与雅可比矩阵构建

传统的反向传播（BP）通常用于纯数字网络。而在该系统中，BP必须穿过物理模型。我们将这种扩展的梯度计算策略称为“NewBP”。其核心特征是**梯度的分流**与**雅可比矩阵的物理化**。

NewBP不再是单向的数据流，而是分裂为两条具有明确物理意义的梯度流：

1. **流向A（对 $W$ 的梯度）**：指导图像复原。
2. **流向B（对 $C$ 的梯度）**：指导系统辨识。

### 4.1 动态雅可比矩阵 (Dynamic Jacobian)

在基础的神经网络中，雅可比矩阵通常是固定的权重矩阵。但在NewBP中，雅可比矩阵是动态的，且由另一个支路的输出决定。

- 对于图像支路，雅可比矩阵 $J_{img} = \frac{\partial \hat{Y}}{\partial \hat{X}}$ 是由当前光学的PSF $K$ 定义的托普利兹矩阵（Toeplitz Matrix）。这意味着**光学的状态决定了图像梯度的传播方式**。
- 对于光学支路，雅可比矩阵 $J_{optics} = \frac{\partial \hat{Y}}{\partial C}$ 描述了“图像像素变化对像差系数的敏感度”。这是一个高度非线性的映射。

下文将分别对这两条流向进行详尽的数学推演。

------

## 5. 流向A：图像复原网络的权重更新推演

我们首先推导NewBP如何指导图像复原网络 $W$ 的更新。这部分揭示了算法如何利用物理模糊核的先验知识来“反解”清晰图像。

### 5.1 链式法则展开

目标是计算 $\frac{\partial \mathcal{L}}{\partial W}$。根据链式法则：
$$
\frac{\partial \mathcal{L}}{\partial W} = \frac{\partial \mathcal{L}}{\partial \hat{X}} \cdot \frac{\partial \hat{X}}{\partial W}
$$
其中 $\frac{\partial \hat{X}}{\partial W}$ 是标准神经网络的梯度反传。NewBP的独特之处在于 $\frac{\partial \mathcal{L}}{\partial \hat{X}}$ 的计算。
$$
\frac{\partial \mathcal{L}}{\partial \hat{X}} = \frac{\partial \mathcal{L}_{fid}}{\partial \hat{X}} + \lambda \frac{\partial \mathcal{L}_{reg}}{\partial \hat{X}}
$$
正则项导数很简单：$2\lambda(\hat{X} - X_{gt})$。重点在于保真项。

### 5.2 卷积操作的伴随算子 (Adjoint of Convolution)

保真项为 $E_1 = ||\hat{X} * K - Y_{real}||^2$。令 $\delta_Y = \hat{Y} - Y_{real}$ 为观测域的残差（Residual）。

我们需要求 $\frac{\partial}{\partial \hat{X}} ||\hat{X} * K - Y_{real}||^2$。

在泛函分析中，卷积算子 $A: x \mapsto x * k$ 的伴随算子（Adjoint Operator） $A^*$ 是与 $k$ 的互相关（Cross-Correlation），或者等价于与翻转核（Flipped Kernel） $k^T$ 的卷积。
$$
k^T(u, v) = k(-u, -v)
$$
数学推导：

展开卷积定义的损失项（为简化符号，使用一维积分形式）：
$$
E_1 = \int \left( \int \hat{X}(\tau) K(t - \tau) d\tau - Y_{real}(t) \right)^2 dt
$$
对 $\hat{X}(x)$ 求变分导数：
$$
\frac{\delta E_1}{\delta \hat{X}(x)} = 2 \int \left( \hat{Y}(t) - Y_{real}(t) \right) \cdot \frac{\partial \hat{Y}(t)}{\partial \hat{X}(x)} dt
$$
注意到 $\hat{Y}(t) = \int \hat{X}(\tau) K(t-\tau) d\tau$，故 $\frac{\partial \hat{Y}(t)}{\partial \hat{X}(x)} = K(t-x)$。

代入得：
$$
\frac{\delta E_1}{\delta \hat{X}(x)} = 2 \int \underbrace{(\hat{Y}(t) - Y_{real}(t))}_{\delta_Y(t)} \cdot K(t-x) dt
$$
令 $u = t - x$，则 $t = x + u$。积分变为：
$$
\int \delta_Y(x+u) K(u) du = \delta_Y(x) \star K(x)
$$
这正是残差 $\delta_Y$ 与核 $K$ 的互相关，也就是 $\delta_Y$ 与翻转核 $K^T$ 的卷积。

### 5.3 物理意义：物理约束的正则化器

最终的图像梯度流公式为：
$$
\frac{\partial \mathcal{L}}{\partial \hat{X}} = \underbrace{2(\hat{Y} - Y_{real}) * K^T}_{\text{Physical Feedback}} + \underbrace{2\lambda(\hat{X} - X_{gt})}_{\text{Supervised Feedback}}
$$
深度洞察：

NewBP在流向A中的作用是物理反卷积反馈。

1. 系统首先计算当前的“模糊残差” $\delta_Y$。
2. 然后，它利用当前对光学系统的最佳估计 $K$，将这个残差“反向模糊”（卷积 $K^T$）回清晰图像域。
3. 这个过程告诉复原网络：“你在位置 $(u,v)$ 生成的像素，经过光学模糊后，导致了观测图像在邻域上的误差。请根据这个光学扩散特性，修正你的输出权重。”

如果 $K$ 是准确的，这一步实际上是在执行迭代式的维纳滤波（Wiener Filtering）或理查德森-露西反卷积（Richardson-Lucy Deconvolution）的梯度下降版本。

------

## 6. 流向B：光学参数（Zernike系数）的微分推演

这是NewBP算法中最具创新性和数学复杂性的部分。我们需要推导损失函数对Zernike系数 $C_j$ 的梯度 $\frac{\partial \mathcal{L}}{\partial C_j}$。这涉及到一条穿透FFT和复数运算的物理导数链。

### 6.1 物理导数链 (Chain of Physical Derivatives)

根据链式法则，导数链如下：
$$
\frac{\partial \mathcal{L}}{\partial C_j} = \sum_{u,v} \left( \frac{\partial \mathcal{L}}{\partial \hat{Y}} \cdot \frac{\partial \hat{Y}}{\partial K} \cdot \frac{\partial K}{\partial P} \cdot \frac{\partial P}{\partial \Phi} \cdot \frac{\partial \Phi}{\partial C_j} \right)
$$
我们将逐环解开这个链条。

### 6.2 第一环：从损失到PSF ($\frac{\partial \mathcal{L}}{\partial K}$)

$$
\hat{Y} = \hat{X} * K
$$

$$
\frac{\partial \mathcal{L}}{\partial K} = \frac{\partial}{\partial K} ||\hat{X} * K - Y_{real}||^2
$$

类似于流向A的推导，但这次变量是卷积核 $K$。卷积对于核也是线性的。
$$
\frac{\partial \mathcal{L}}{\partial K(u, v)} = 2 (\hat{Y} - Y_{real}) \star \hat{X}
$$
或者写成卷积形式：
$$
\nabla_K \mathcal{L} = 2 \cdot \delta_Y * \hat{X}^T
$$
这意味着：损失对PSF中某一点权重的梯度，等于图像残差与估计的清晰图像的互相关。

物理含义：这实际上是在询问，“什么样的卷积核形状，能够最好地解释清晰图像 $\hat{X}$ 和模糊观测 $Y_{real}$ 之间的差异？”。如果残差中存在某种方向的拖尾，互相关操作会在 $K$ 的相应位置产生高响应，指示梯度下降增加该方向的权重。

### 6.3 第二环：从PSF到广义光瞳函数 ($\frac{\partial K}{\partial P}$) —— 复数微分

这是最关键的一步，涉及跨越傅里叶变换域和模平方非线性。

已知：$$U = \mathcal{F}\{P\}$$ 且 $$K = |U|^2 = U \odot U^*$$ ($\odot$ 表示逐元素乘法，$^*$ 表示复共轭)。

我们需要计算 $\nabla_P \mathcal{L}$。首先计算 $\nabla_U \mathcal{L}$。

由于 $K$ 是实数，损失 $\mathcal{L}$ 也是实数，我们利用Wirtinger微积分（Wirtinger Calculus）处理复变量导数。

对于 $K = U U^*$，全微分 $dK = U dU^* + U^* dU$。

根据链式法则：
$$
d\mathcal{L} = \langle \nabla_K \mathcal{L}, dK \rangle = \sum (\nabla_K \mathcal{L}) (U dU^* + U^* dU)
$$
这意味着损失对 $U$ 的Wirtinger导数（共轭梯度）为：
$$
\nabla_U \mathcal{L} = \frac{\partial \mathcal{L}}{\partial U} = (\nabla_K \mathcal{L}) \odot U^*
$$
为了在梯度下降中使用，通常使用共轭形式（或者直接推导实部梯度），在实数域优化中，等效的反传梯度为：
$$
\delta_U = 2 \cdot (\nabla_K \mathcal{L}) \odot U
$$
(注：系数2来源于模平方导数 $2x$)。

接下来穿过逆傅里叶变换（IFFT）。由于 $U = \mathcal{F}\{P\}$，根据Parseval定理和FFT的线性性质，梯度的反传也是通过傅里叶变换（或其逆变换，取决于定义）：
$$
\nabla_P \mathcal{L} = \mathcal{F}^{-1} \{ \nabla_U \mathcal{L} \} = \mathcal{F}^{-1} \{ 2 \cdot (\nabla_K \mathcal{L}) \odot \mathcal{F}\{P\} \}
$$
物理含义（全息反向传播）：

这一步极具物理美感。$\nabla_K \mathcal{L}$ 是PSF平面的误差图。将其与当前的光场 $\mathcal{F}\{P\}$ 相乘（干涉），然后进行逆傅里叶变换，实际上是将像平面的误差全息地（Holographically）反向传播回光瞳平面。得到的 $\nabla_P \mathcal{L}$ 是一个复数场，指示了光瞳平面上各点的振幅和相位应该如何变化。

### 6.4 第三环：从光瞳函数到波前相位 ($\frac{\partial P}{\partial \Phi}$)

已知 $P = A \cdot e^{i k \Phi}$。我们需要从复数光瞳梯度 $\nabla_P \mathcal{L}$ 中提取出对实数相位 $\Phi$ 的梯度 $\nabla_\Phi \mathcal{L}$。

根据链式法则：
$$
\frac{\partial P}{\partial \Phi} = A \cdot i k \cdot e^{i k \Phi} = i k P
$$
利用复数链式法则 $\frac{\partial \mathcal{L}}{\partial \Phi} = \text{Re} \{ (\frac{\partial \mathcal{L}}{\partial P})^* \frac{\partial P}{\partial \Phi} \}$（针对实变量函数的复导数投影）：
$$
\nabla_\Phi \mathcal{L} = \text{Re} \{ (\nabla_P \mathcal{L})^* \cdot (i k P) \}
$$
利用复数性质 $\text{Re}\{ -i z \} = \text{Im}\{ z \}$，以及忽略常数 $k$（归入学习率）：
$$
\nabla_\Phi \mathcal{L} \propto \text{Im} \{ (\nabla_P \mathcal{L})^* \cdot P \}
$$
或者等价地：
$$
\nabla_\Phi \mathcal{L} = \text{Im} \{ \overline{\nabla_P \mathcal{L}} \cdot P \}
$$
物理含义（相位残差提取）：

这一步从光瞳平面的复数误差中，分离出了纯相位误差。虚部操作（Imaginary part）本质上是在提取垂直于当前相量方向的分量，这正是驱动相位旋转（即改变光程差）所需的“力矩”。得到的 $\nabla_\Phi \mathcal{L}(\rho, \theta)$ 是一个定义在单位圆上的二维标量场，表示“为了减少最终图像误差，光瞳上每一点的相位应该增加还是减少”。

### 6.5 第四环：Zernike模态投影 ($\frac{\partial \Phi}{\partial C_j}$) —— 降维求解

最后一步是将密集的相位误差图 $\nabla_\Phi \mathcal{L}$ 投影到低维的Zernike参数空间。

由于 $\Phi = \sum C_j Z_j$，偏导数简单地为：
$$
\frac{\partial \Phi}{\partial C_j} = Z_j(\rho, \theta)
$$
因此，对第 $j$ 个Zernike系数的总梯度是相位误差图与该Zernike模式的内积（Inner Product）：
$$
\frac{\partial \mathcal{L}}{\partial C_j} = \iint_{\text{Unit Disk}} \nabla_\Phi \mathcal{L}(\rho, \theta) \cdot Z_j(\rho, \theta) \cdot \rho d\rho d\theta
$$
在离散计算中，即为点积求和：
$$
\frac{\partial \mathcal{L}}{\partial C_j} = \sum_{u,v} \left( \nabla_\Phi \mathcal{L}[u,v] \cdot Z_j[u,v] \right)
$$
综合梯度公式：
$$
\frac{\partial \mathcal{L}}{\partial C_j} = \text{Sum} \left( \text{Im} \left\{ \mathcal{F}^{-1} \left[ \left( \frac{\partial \mathcal{L}}{\partial E} \right) \cdot \frac{E}{|E|} \right] \cdot P^* \right\} \cdot Z_j \right)
$$

$$
\frac{\partial \mathcal{L}}{\partial C_j} = \sum \text{Im} \left\{ \mathcal{F}^{-1} \{ A \} \cdot P^* \cdot Z_j \right\}
$$

NewBP算法的精髓：

这个公式展示了NewBP如何“自动微分光学”。它不需要对 $C_j$ 进行数值差分（这需要运行 $M$ 次前向传播），而是通过一次反向传播，利用FFT和点乘，同时计算出所有 $M$ 个Zernike系数的精确梯度。

- 如果相位误差图 $\nabla_\Phi \mathcal{L}$ 呈现出马鞍形（Saddle shape），它与像散项 $Z_5$ 的点积将很大，从而强烈更新 $C_5$。
- 如果相位误差图呈现碗状（Bowl shape），它将主要激活离焦项 $C_4$ 的更新。
- 这实现了**基于物理特征的自动参数寻优**。

------

## 7. 空间变变系统中的NewBP策略：重叠相加法(OLA)与串扰处理

实际光学系统（特别是广角镜头）的像差是随视场（Field of View）变化的。中心视场可能近乎完美，而边缘视场可能存在严重的彗差和像散。因此，单一的 $C$ 向量无法描述全图。我们引入空间变变模型，并利用NewBP处理由此产生的“串扰”（Crosstalk）问题。

### 7.1 重叠相加法 (Overlap-Add, OLA) 数据流

为了计算效率，我们将大图 $X$ 切分为 $M \times N$ 个重叠的块（Patch）。

1. **分块**：将 $X$ 切分为 $X_i$。
2. **局部预测**：光学网络 $g_{\theta}(u_i, v_i)$ 输出该块中心的Zernike系数 $C_i$。
3. **局部PSF**：生成 $K_i = \text{PSF}(C_i)$。
4. **局部卷积**：$O_i = X_i * K_i$。
5. **加权融合**：$\hat{Y} = \sum_i (O_i \cdot W_i)$，其中 $W_i$ 是消除块效应的窗函数（如Hanning窗）。

### 7.2 串扰（Crosstalk）的物理本质与梯度处理

在1代码片段中提到的“NewBP算法：考虑串扰的梯度计算”虽然是针对半导体光放大器（SOA）的信道串扰，但其数学原理与OLA中的空间串扰完全同构。

定义串扰：

在OLA中，观测图像 $\hat{Y}$ 上的某一个像素 $y_{pixel}$，并非只由一个Patch贡献，而是由所有覆盖该像素的重叠Patch共同加权求和而成。因此，该像素上的误差 $\delta_y$ 对 $C$ 的梯度具有“一对多”的依赖关系。这就是空间串扰。

NewBP的串扰梯度聚合策略：

在反向传播时，NewBP必须正确地将全局梯度 $\delta_{global}$ 分配给每个局部的Zernike系数 $C_i$。

根据链式法则：
$$
\frac{\partial \mathcal{L}}{\partial C_i} = \sum_{p \in \Omega_{\hat{Y}}} \frac{\partial \mathcal{L}}{\partial \hat{Y}_p} \frac{\partial \hat{Y}_p}{\partial C_i}
$$
由于 $\hat{Y} = \sum_k (X_k * K_k) \cdot W_k$，只有当 $k=i$ 时导数不为零。
$$
\frac{\partial \hat{Y}}{\partial C_i} = (X_i * \frac{\partial K_i}{\partial C_i}) \cdot W_i
$$
代入梯度公式，我们得到NewBP在处理OLA时的修正步骤：

1. 全局残差加窗：对于第 $i$ 个Patch，其“有效误差”不是简单的局部裁剪，而是全局误差 $\delta_Y$ 与窗函数 $W_i$ 的乘积。
   $$
   \delta_{eff}^{(i)} = \delta_Y \cdot W_i
   $$
   这一步解决了串扰问题：它隔离了Patch $i$ 对总误差的贡献权重。

2. 局部反传：将加窗后的残差 $\delta_{eff}^{(i)}$ 代入第6节推导的Zernike梯度公式中。
   $$
   \nabla_{C_i} \mathcal{L} = \text{ZernikeProjection} \left( \text{PhaseGradient}(\hat{X}_i, \delta_{eff}^{(i)}, P_i) \right)
   $$

结论：

通过引入加窗残差 $\delta_{eff}^{(i)}$，NewBP算法巧妙地将复杂的全局串扰解耦为一系列局部的独立优化问题，同时在数学上保持了全图梯度的严格一致性。这使得网络能够学习到平滑变化的Zernike系数场，例如在图像中心预测 $C \approx 0$，而在边缘预测较大的 $C_{coma}$。

